<?xml version="1.0" encoding="utf-8"?>
<package name="modelCovidseir" displayName="Add-On to the Epidemic Package for the covidSEIR model" isAddOn="True" extendsPackage="epi" version="1.0.0">
	<transformers>
		<transformer
			name="modelCovidseir_Download"
			isPrimary="True"
			displayName="modelCovidseir_Download"
			programName="Rscript"
			programArguments="gather.R"
			extendsTransformer="epi_Primary"
			runContext="LocalOnly"
			isRunnable="True">
			<datafeeds>
				<datafeed name="DelayFileInfo" displayName="rightTruncation Delay Data" dataScope="Scenario">
          <datasheets>
            <datasheet name="DelayFileInfo" displayName="rightTruncation Delay Data" isSingleRow="True">
              <columns>
                <column name="InputDatasheetID" dataType="Integer" isPrimary="True"/>
                <column name="ScenarioID" dataType="Integer"/>
                <column name="delayURL" dataType="String" displayName="Case Reporting Delay Data URL"/>
								<column name="DelayDataFile" displayName="Case Reporting Delay Data File" dataType="String" isExternalFile="True"/>
								<column name="DownloadDateTime" displayName="Download Date/Time" dataType="Date"/>
              </columns>
							<defaultRecords>
								<record columns="delayURL" values="https://github.com/andrew-edwards/rightTruncation/raw/master/data/delay_data_2021_01_05.rda"/>
							</defaultRecords>
            </datasheet>
          </datasheets>
        </datafeed>
				<datafeed name="RawDelayData" displayName="Raw Output" dataScope="Scenario" isOutput="True">
          <datasheets>
            <datasheet name="RawDelayData" displayName="Raw Output">
              <columns>
                <column name="ScenarioID" dataType="Integer"/>
                <column name="dateReported" dataType="String" displayName="Day on which each case was reported"/>
                <column name="dateSymptom" dataType="String" displayName="Day on which symptoms appeared"/>
                <column name="reportingGap" dataType="Integer" displayName="Delay between symptoms and case report (days)"/>
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>
				<datafeed name="WeibullParameters" displayName="Weibull Shape and Scale Parameters" dataScope="Scenario" isOutput="True">
					<datasheets>
						<datasheet name="WeibullParameters" displayName="Weibull Shape and Scale Parameters" isSingleRow="True">
							<columns>
								<column name="ScenarioID" dataType="Integer"/>
								<column name="mleShape" dataType="Double" displayName="Shape Parameter"/>
								<column name="mleScale" dataType="Double" displayName="Scale Parameter"/>
							</columns>
						</datasheet>
					</datasheets>
				</datafeed>
			</datafeeds>
			<include>
				<transformer name="modelCovidseir_Fit"/>
				<transformer name="modelCovidseir_Project"/>
			</include>
		</transformer>
		<transformer
			name="modelCovidseir_Fit"
			displayName="modelCovidseir_Fit"
			programName="Rscript"
			programArguments="fit.R"
			extendsTransformer="epi_Primary"
			isRunnable ="True">
			<datafeeds>
				<datafeed name="ContactRateFractions" displayName="Contact Rate Fractions" dataScope="Scenario">
					<datasheets>
						<datasheet name="ContactRateFractions" displayname="Contact Rate Fractions">
							<columns>
								<column name="InputDatasheetID" dataType="Integer" isPrimary="True" isInput="True"/>
								<column name="ScenarioID" dataType="Integer"/>
								<column name="BreakDay" dataType="Integer" displayName="Breakpoint Day"/>
								<column name="PriorMean" dataType="Double" displayName="Prior Mean"/>
								<column name="PriorSD" dataType="Double" displayName="Prior SD"/>
							</columns>
							<defaultRecords>
								<record columns="BreakDay|PriorMean|PriorSD" values="0|0.4|0.2"/>
								<record columns="BreakDay|PriorMean|PriorSD" values="322|0.7|0.2"/>
								<record columns="BreakDay|PriorMean|PriorSD" values="247|0.95|0.2"/>
								<record columns="BreakDay|PriorMean|PriorSD" values="292|0.45|0.2"/>
							</defaultRecords>
						</datasheet>
					</datasheets>
				</datafeed>
				<datafeed name="SamplingFractions" displayName="Sampling Fractions" dataScope="Scenario">
					<datasheets>
						<datasheet name="SamplingFractions" displayName="Sampling Fractions">
							<columns>
								<column name="InputDatasheetID" dataType="Integer" isPrimary="True" isInput="True"/>
								<column name="ScenarioID" dataType="Integer"/>
								<column name="Day" dataType="Integer" displayName="Day"/>
								<column name="Proportion" dataType="Double" displayName="Proportion [samp_frac_fixed]"/>
							</columns>
							<defaultRecords>
								<record columns="Day|Proportion" values="0|0.2"/>
								<record columns="Day|Proportion" values="24|0.305"/>
								<record columns="Day|Proportion" values="26|0.67"/>
								<record columns="Day|Proportion" values="87|0.745"/>
								<record columns="Day|Proportion" values="130|0.814"/>
								<record columns="Day|Proportion" values="152|0.628"/>
								<record columns="Day|Proportion" values="158|0.775"/>
								<record columns="Day|Proportion" values="181|0.822"/>
								<record columns="Day|Proportion" values="208|0.134"/>
								<record columns="Day|Proportion" values="201|0.992"/>
							</defaultRecords>
						</datasheet>
					</datasheets>
				</datafeed>
				<datafeed name="General" displayName="General" dataScope="Scenario">
					<datasheets>
						<datasheet name="General" displayName="General" isSingleRow="True">
							<columns>
								<column name="ScenarioID" dataType="Integer" isPrimary="True" isInput="True"/>
								<column name="NPop" dataType="Integer" displayName="Population size [N_pop]"/>
								<column name="I0PriorMean" dataType="Double" displayName="Initial Infected - prior mean [i0_prior mean]"/>
								<column name="I0PriorSD" dataType="Double" displayName="Initial Infected - prior SD [i0_prior SD]"/>
								<column name="R0PriorMean" dataType="Double" displayName="R0 - prior mean [R0_prior mean]"/>
								<column name="R0PriorSD" dataType="Double" displayName="R0 - prior SD [R0_prior SD]"/>
								<column name="EPriorMean" dataType="Double" displayName="Social distancing fraction - prior mean [e_prior mean]"/>
								<column name="EPriorSD" dataType="Double" displayName="Social distancing fraction - prior SD [e_prior SD]"/>
								<column name="StartDeclinePriorMean" dataType="Double" displayName="Start decline day - prior mean [start_decline_prior mean]"/>
								<column name="StartDeclinePriorSD" dataType="Double" displayName="Start decline day - prior SD [start_decline_prior SD]"/>
								<column name="EndDeclinePriorMean" dataType="Double" displayName="End decline day - prior mean [end_decline_prior mean]"/>
								<column name="EndDeclinePriorSD" dataType="Double" displayName="End decline day - prior SD [end_decline_prior SD]"/>
								<column name="FitType" dataType="Integer" displayName="Fit type [fit_type]" validationType="List" formula1="1:NUTS | 2:VB | 3:optimising"/>
								<column name="YAML" dataType="String" displayName="Advanced settings YAML filename" isExternalFile="True"/>
								<column name="RDS" dataType="String" displayName="Fit Result RDS Filename"/>
							</columns>
							<defaultRecords>
								<record columns="NPop|I0PriorMean|I0PriorSD|R0PriorMean|R0PriorSD|EPriorMean|EPriorSD|StartDeclinePriorMean|StartDeclinePriorSD|EndDeclinePriorMean|EndDeclinePriorSD|FitType|RDS" values="5071000|8|1|2.6|0.2|0.8|0.05|15|0.05|22|0.05|3|modelCovidseir_fit"/>
							</defaultRecords>
						</datasheet>
					</datasheets>
				</datafeed>
				<datafeed name="FitRawOutput" displayName="Raw Output" dataScope="Scenario" isOutput="True">
					<datasheets>
						<datasheet name="TidyRawOutput" displayName="Raw Output">
							<columns>
								<column name="ScenarioID" dataType="Integer"/>
								<column name="Date" dataType="Date" displayName="Date"/>
								<column name="Day" dataType="Integer" displayName="Days elapsed"/>
								<column name="YRepMean" dataType="Double" displayName=""/>
								<column name="YRep05" dataType="Double" displayName=""/>
								<column name="YRep25" dataType="Double" displayName=""/>
								<column name="YRep50" dataType="Double" displayName=""/>
								<column name="YRep75" dataType="Double" displayName=""/>
								<column name="YRep95" dataType="Double" displayName=""/>
								<column name="MuMean" dataType="Double" displayName=""/>
								<column name="Mu05" dataType="Double" displayName=""/>
								<column name="Mu25" dataType="Double" displayName=""/>
								<column name="Mu50" dataType="Double" displayName=""/>
								<column name="Mu75" dataType="Double" displayName=""/>
								<column name="Mu95" dataType="Double" displayName=""/>
							</columns>
						</datasheet>
					</datasheets>
				</datafeed>
				<datafeed name="FitPosteriors" displayName="Posteriors" dataScope="Scenario" isOutput="True">
					<datasheets>
						<datasheet name="FitPosteriors" displayName="Posteriors">
							<columns>
								<column name="ScenarioID" dataType="Integer"/>
								<column name="Iteration" dataType="Integer" displayName="Iteration"/>
								<column name="I0Post" dataType="Double" displayName="Initial Infected"/>
								<column name="R0Post" dataType="Double" displayName="R0"/>
								<column name="EPost" dataType="Double" displayName="Social distancing fraction"/>
								<column name="StartDeclinePost" dataType="Double" displayName="Start decline day"/>
								<column name="EndDeclinePost" dataType="Double" displayName="End decline day"/>
								<column name="PhiPost" dataType="Double" displayName="Dispersion parameter"/>
								<column name="FSeg1Post" dataType="Double" displayName="Contact rate fraction 1"/>
								<column name="FSeg2Post" dataType="Double" displayName="Contact rate fraction 2"/>
								<column name="FSeg3Post" dataType="Double" displayName="Contact rate fraction 3"/>
								<column name="FSeg4Post" dataType="Double" displayName="Contact rate fraction 4"/>
							</columns>
						</datasheet>
					</datasheets>
				</datafeed>
			</datafeeds>
		</transformer>
		<transformer
		  name="modelCovidseir_Project"
		  displayName="modelCovidseir_Project"
		  programName="Rscript"
		  programArguments="project.R"
		  extendsTransformer="epi_Primary"
		  isRunnable ="True">
		  <datafeeds>
		    <datafeed name="ProjParams" displayName="Parameters" dataScope="Scenario" isInput="True">
		      <datasheets>
		        <datasheet name="ProjParams" displayName="Parameters" isSingleRow="True">
		          <columns>
		            <column name="ScenarioID" dataType="Integer" isPrimary="True" isInput="True"/>
		            <column name="StartChange" dataType="Integer" displayName="Day of social distancing change"/>
		            <!-- this number must be one of the columns of the segment table -->
		            <column name="Resampling" dataType="Integer" displayName="Number of Samples"/>
		            <column name="FSegment" dataType="Integer" displayName="Social distancing segment"/>
		            <column name="Parallel" dataType="Integer" displayName="Parallel processing" validationType="List" formula1="1:Yes|0:No"/>
		          </columns>
		          <defaultRecords>
		            <record columns="StartChange|FSegment|Resampling|Parallel" values="5|1|30|1"/>
		          </defaultRecords>
		        </datasheet>
		      </datasheets>
		    </datafeed>
				<datafeed name="FitFileInfo" displayName="Fit Data RDS" dataScope="Scenario">
					<datasheets>
						<datasheet name="FitFileInfo" displayName="Fit File Data" isSingleRow="True">
							<columns>
								<column name="InputDatasheetID" dataType="Integer" isPrimary="True"/>
								<column name="ScenarioID" dataType="Integer"/>
								<column name="FitDataFile" displayName="Fit Information Object File" dataType="String" isExternalFile="True"/>
								<column name="MadeDateTime" displayName="Download Date/Time" dataType="Date"/>
							</columns>
						</datasheet>
					</datasheets>
				</datafeed>
				<datafeed name="SimData" displayName="Projection Data" dataScope="Scenario" isOutput="True">
					<datasheets>
						<datasheet name="SimData" displayName="Projection Data">
							<columns>
								<column name="ScenarioID" displayName="Scenario" dataType="Integer"/>
								<column name="Iteration" dataType="Integer" displayName="Iteration"/>
								<column name="Timestep" dataType="Date" displayName="Timestep"/>
								<column name="Variable" dataType="String" displayName="Variable"/>
								<column name="Jurisdiction" dataType="String" displayName="Jurisdiction" />
								<column name="AgeMin" displayName="Age Min" dataType="Integer"/>
								<column name="AgeMax" displayName="Age Max" dataType="Integer"/>
								<column name="Sex" dataType="Integer" displayName="Sex"/>
								<column name="Value" dataType="Double" displayName="Value"/>
							</columns>
						</datasheet>
					</datasheets>
				</datafeed>
		  </datafeeds>
		</transformer>
	</transformers>
	<layouts>
		<layout name="coreforms_ScenarioDatafeeds">
			<item name="DelayFileInfo" displayName="rightTruncation Delay Data" appendTo="epi_Sources"/>
			<item name="FitFileInfo" displayName="modelCovidseir Fit Object File" appendTo="epi_Sources"/>
			<group name='CovidSeir' displayName="CovidSeir" appendTo="epi_Models">
				<group name="DelayData" displayName="Case Reporting Delays" appendTo="CovidSeir">
					<item name="RawDelayData"/>
					<item name="WeibullParameters"/>
				</group>
				<group name="FitModel" displayName="Fit Model" appendTo="CovidSeir">
					<group name="FitInputs" displayName="Inputs" appendTo="FitModel">
						<item name="General"/>
						<item name="SamplingFractions"/>
						<item name="ContactRateFractions"/>
					</group>
					<group name="FitOutputs" displayName="Outputs" appendTo="FitModel">
						<!-- <item name="FitRawOutput"/> -->
						<item name="FitPosteriors"/>
					</group>
				</group>
				<group name="Projection" displayName="Projection" appendTo="CovidSeir">
					<item name="ProjParams"/>
					<item name="SimData"/>
				</group>
			</group>
		</layout>
		<!-- <item name="Variable" datasheet="SimData" column="Value" variableSourceColumn="Variable" prefixFolderName="False" appendTo="epi_Variables"/> -->
		<!-- <layout name="modelCovidseir_Charts" configurationSheet="RunControl" xAxisLabelFormat="yyyy-MMM-dd">
			<group name="Variables" dataSheet="DataSummary" filter="Jurisdiction">
				<item name="Variable" dataSheet="DataSummary" column="Value" variableSourceColumn="Variable" prefixFolderName="False"/>
			</group>
		</layout> -->
	</layouts>
</package>
